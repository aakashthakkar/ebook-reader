<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Audio - Modern Reader (v8.0 PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- PDF.js Library for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    
    <style>
        .upload-area {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(20px);
            border: 2px dashed rgba(147, 197, 253, 0.3);
        }
        .upload-area:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.1), 0 10px 10px -5px rgba(59, 130, 246, 0.04);
        }
        .upload-area.dragover {
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* PDF Viewer Styles */
        #pdf-viewer { position: relative; overflow: auto; height: 80vh; background: #52525b; padding: 20px 0; }
        .pdf-page { position: relative; margin: 20px auto; background: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .pdf-page canvas { display: block; width: 100%; height: auto; }
        .text-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; }
        .text-span {
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .text-span:hover { background-color: rgba(59, 130, 246, 0.3) !important; }
        .text-span.word-playing-chunk { background-color: rgba(34, 197, 94, 0.2) !important; }
        .text-span.word-next-chunk { background-color: rgba(59, 130, 246, 0.15) !important; }
        .text-span.word-current {
            background-color: rgba(34, 197, 94, 0.6) !important;
            animation: pulse 1.5s infinite;
            z-index: 10 !important;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1.0); } 50% { transform: scale(1.05); } }
        
        #sticky-audio-player {
            position: fixed !important; top: 20px !important; right: 20px !important; width: 360px !important;
            max-width: calc(100vw - 40px) !important; z-index: 9999 !important;
            background: rgba(15, 23, 42, 0.9) !important; backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 16px !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important; padding: 20px !important;
            
            opacity: 0;
            visibility: hidden;
            transform: translateX(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }
        #sticky-audio-player.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 min-h-screen text-gray-200">
    <nav class="bg-black/20 backdrop-blur-xl border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="p-2 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg"><i data-lucide="headphones" class="h-6 w-6 text-white"></i></div>
                    <h1 class="text-xl font-bold text-white">PDF Audio Reader</h1>
                </div>
                <div class="text-sm text-gray-300 hidden md:block flex items-center">
                    <i data-lucide="mouse-pointer-click" class="h-4 w-4 mr-2"></i> Click any word to start playing
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="upload-container">
            <div class="text-center mb-8">
                <h2 class="text-5xl font-bold text-white mb-4 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">Interactive PDF Listening</h2>
                <p class="text-lg text-gray-300 max-w-3xl mx-auto">Upload your PDF and click any word to start listening with synchronized text highlighting.</p>
            </div>
            <div class="glass-card p-8 mb-8 fade-in">
                <div id="upload-area" class="upload-area rounded-2xl p-12 text-center cursor-pointer group">
                    <div class="flex flex-col items-center space-y-4">
                        <i data-lucide="cloud-upload" class="h-12 w-12 text-blue-400"></i>
                        <h4 class="text-2xl font-semibold text-white">Drop your PDF here</h4>
                        <p class="text-lg text-gray-300">or <span class="text-blue-400 font-medium">click to browse</span></p>
                    </div>
                    <input type="file" id="pdf-input" accept=".pdf" class="hidden">
                    <div id="upload-loading" class="hidden mt-8">
                        <div class="w-8 h-8 mx-auto spinner border-4 border-blue-400 border-t-transparent rounded-full"></div>
                        <p class="text-lg font-medium text-blue-300 mt-4" id="upload-loading-text">Processing PDF...</p>
                    </div>
                </div>
                <div id="file-info" class="hidden mt-6 p-4 bg-green-500/10 rounded-xl border border-green-500/30">
                    <div class="font-semibold text-green-300" id="file-name"></div>
                    <div class="text-sm text-green-200"><span id="word-count"></span> words â€¢ <span id="chunk-count"></span> audio segments</div>
                </div>
            </div>
        </div>

        <div id="pdf-display" class="hidden fade-in">
            <div class="flex items-center justify-between mb-4 flex-wrap gap-4">
                <h3 class="text-xl font-semibold text-white">Interactive PDF Viewer</h3>
                <button id="read-another-pdf-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-all">Read Another PDF</button>
            </div>
            <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 mb-4 border border-white/10">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <div class="flex items-center space-x-2">
                        <button id="pdf-prev-page" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md disabled:opacity-50"><i data-lucide="chevron-left" class="h-5 w-5"></i></button>
                        <span class="text-sm">Page <input type="number" id="pdf-page-input" min="1" value="1" class="bg-gray-800 w-16 text-center rounded-md"> of <span id="pdf-total-pages">1</span></span>
                        <button id="pdf-next-page" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md disabled:opacity-50"><i data-lucide="chevron-right" class="h-5 w-5"></i></button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="pdf-zoom-out" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md"><i data-lucide="zoom-out" class="h-5 w-5"></i></button>
                        <span id="pdf-zoom-level" class="text-sm font-medium w-16 text-center">100%</span>
                        <button id="pdf-zoom-in" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md"><i data-lucide="zoom-in" class="h-5 w-5"></i></button>
                        <button id="pdf-fit-width" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-md"><i data-lucide="move-horizontal" class="h-5 w-5"></i></button>
                    </div>
                </div>
            </div>
            <div id="loading-indicator" class="hidden mb-4 p-3 bg-blue-500/20 rounded-lg border border-blue-500/30 flex items-center text-blue-300">
                <div class="spinner h-4 w-4 border-2 border-blue-300 border-t-transparent rounded-full mr-2"></div>
                <span id="loading-text"></span>
            </div>
            <div id="pdf-container" class="glass-card rounded-xl overflow-hidden"><div id="pdf-viewer"></div></div>
        </div>
        <div id="error-section" class="hidden mt-4 bg-red-500/20 p-4 rounded-xl border border-red-500/30"><p id="error-message" class="text-red-200"></p></div>
    </div>

    <div id="sticky-audio-player">
        <div class="flex items-center justify-between mb-4">
            <span class="text-xs text-gray-300 font-medium flex items-center"><div class="w-2 h-2 bg-green-400 rounded-full animate-pulse mr-2"></div>Now Playing</span>
            <button id="sticky-close-btn" class="p-1 hover:bg-white/10 rounded-full"><i data-lucide="x" class="h-4 w-4 text-gray-400"></i></button>
        </div>
        <div class="flex items-center space-x-4">
            <button id="sticky-play-pause-btn" class="p-3 rounded-full bg-gradient-to-r from-blue-500 to-purple-500"><i data-lucide="pause" class="h-5 w-5 text-white"></i></button>
            <div class="flex-1 space-y-2">
                <select id="sticky-voice-select" class="w-full bg-gray-800/80 text-white text-xs rounded-lg px-3 py-2 border border-gray-600/50 focus:border-blue-400 outline-none">
                    {% for key, model in models.items() %}<option value="{{ key }}" {% if key == 'edge-tts-andrew' %}selected{% endif %}>{{ model.name }}</option>{% endfor %}
                </select>
                <select id="sticky-speed-select" class="w-full bg-gray-800/80 text-white text-xs rounded-lg px-3 py-2 border border-gray-600/50 focus:border-blue-400 outline-none">
                    <option value="0.75">0.75x</option><option value="1.0">1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2.0">2.0x</option>
                </select>
            </div>
            <button id="sticky-stop-btn" class="p-3 rounded-full bg-red-500/20 hover:bg-red-500/30 text-red-300"><i data-lucide="square" class="h-5 w-5"></i></button>
        </div>
    </div>

    <audio id="audio-player-element" style="display:none;"></audio>

    <script>
        lucide.createIcons();
        
        // --- GLOBAL STATE --- //
        let wordMap = [];
        let pdfDoc = null, pdfTotalPages = 0, pdfCurrentPageNum = 1, pdfScale = 1.5, pdfRenderingInProgress = false;
        let audioCache = new Map(), gaplessPlayer = null, isPlaying = false, isPaused = false, currentChunk = null;
        let currentPlaybackRate = "1.0", selectedModel = 'edge-tts-andrew';

        const $ = (id) => document.getElementById(id);
        
        // --- INITIALIZATION --- //
        document.addEventListener('DOMContentLoaded', () => {
            loadUserPreferences();
            applyPreferencesToUI();
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = $('upload-area');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', (e) => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
            uploadArea.addEventListener('click', () => $('pdf-input').click());
            $('pdf-input').addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
            
            $('sticky-play-pause-btn').addEventListener('click', togglePlayPause);
            $('sticky-stop-btn').addEventListener('click', stopPlayback);
            $('sticky-close-btn').addEventListener('click', stopPlayback);
            $('sticky-speed-select').addEventListener('change', (e) => changePlaybackRate(parseFloat(e.target.value)));
            $('sticky-voice-select').addEventListener('change', (e) => handleVoiceChange(e.target.value));
            
            $('read-another-pdf-btn').addEventListener('click', resetToUpload);
            
            document.addEventListener('keydown', (e) => { 
                if (document.activeElement.tagName !== 'INPUT' && e.key === ' ') { 
                    e.preventDefault(); 
                    togglePlayPause(); 
                } 
            });
        }

        // --- PDF PROCESSING & RENDERING --- //
        async function handleFile(file) {
            if (!file.type.includes('pdf')) return showError('Please select a PDF file.');
            showUploadLoading(true, 'Uploading and processing PDF...');
            await stopPlayback();
            resetPdfState();

            const formData = new FormData();
            formData.append('file', file);

            try {
                // 1. Upload and get word data from server
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error during PDF processing');
                }

                const data = await response.json();
                wordMap = data.words;

                // 2. Concurrently, load PDF for rendering on client
                const arrayBuffer = await file.arrayBuffer();
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                pdfTotalPages = pdfDoc.numPages;

                // 3. Update UI and render
                updateFileInfo(data.filename, data.word_count);
                $('upload-container').classList.add('hidden');
                $('pdf-display').classList.remove('hidden');
                
                setupPdfControls();
                await renderPage(1);

            } catch (error) {
                showError('Failed to process PDF: ' + error.message);
                console.error(error);
                resetToUpload();
            } finally {
                showUploadLoading(false);
            }
        }
        
        async function renderPage(pageNum) {
            if (pdfRenderingInProgress) return;
            pdfRenderingInProgress = true;
            pdfCurrentPageNum = pageNum;
            $('pdf-page-input').value = pageNum;
            showLoading('Rendering page...');

            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: pdfScale });

            const pageDiv = document.createElement('div');
            pageDiv.className = 'pdf-page';
            pageDiv.style.width = `${viewport.width}px`;
            pageDiv.style.height = `${viewport.height}px`;

            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pageDiv.appendChild(canvas);

            const textLayer = document.createElement('div');
            textLayer.className = 'text-layer';
            pageDiv.appendChild(textLayer);
            
            $('pdf-viewer').innerHTML = '';
            $('pdf-viewer').appendChild(pageDiv);

            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

            const wordsOnPage = wordMap.filter(w => w.page === pageNum);
            if (wordsOnPage.length === 0) {
                pdfRenderingInProgress = false;
                hideLoading();
                updatePdfNavButtons();
                return;
            }

            const originalPage = {width: wordsOnPage[0].page_width, height: wordsOnPage[0].page_height};
            const scaleX = viewport.width / originalPage.width;
            const scaleY = viewport.height / originalPage.height;

            for (const word of wordsOnPage) {
                const span = document.createElement('span');
                span.className = 'text-span';
                span.dataset.wordIndex = word.index;
                
                const style = span.style;
                style.left = `${word.x * scaleX}px`;
                style.top = `${word.y * scaleY}px`;
                style.width = `${word.width * scaleX}px`;
                style.height = `${word.height * scaleY}px`;

                span.addEventListener('click', () => playFromWord(word.index));
                textLayer.appendChild(span);
            }

            pdfRenderingInProgress = false;
            hideLoading();
            updatePdfNavButtons();
            if (isPlaying || isPaused) updateHighlighting();
        }

        function setupPdfControls() {
            $('pdf-prev-page').addEventListener('click', () => { if (pdfCurrentPageNum > 1) renderPage(pdfCurrentPageNum - 1); });
            $('pdf-next-page').addEventListener('click', () => { if (pdfCurrentPageNum < pdfTotalPages) renderPage(pdfCurrentPageNum + 1); });
            $('pdf-page-input').addEventListener('change', (e) => { const page = parseInt(e.target.value); if (page >= 1 && page <= pdfTotalPages) renderPage(page); });
            $('pdf-zoom-in').addEventListener('click', () => { pdfScale += 0.25; renderPage(pdfCurrentPageNum); });
            $('pdf-zoom-out').addEventListener('click', () => { if (pdfScale > 0.5) { pdfScale -= 0.25; renderPage(pdfCurrentPageNum); }});
            $('pdf-fit-width').addEventListener('click', async () => {
                const page = await pdfDoc.getPage(pdfCurrentPageNum);
                pdfScale = $('pdf-viewer').clientWidth / page.getViewport({ scale: 1 }).width;
                renderPage(pdfCurrentPageNum);
            });
            $('pdf-total-pages').textContent = pdfTotalPages;
            updatePdfNavButtons();
        }

        function updatePdfNavButtons() {
            $('pdf-prev-page').disabled = (pdfCurrentPageNum <= 1);
            $('pdf-next-page').disabled = (pdfCurrentPageNum >= pdfTotalPages);
            $('pdf-zoom-level').textContent = `${Math.round(pdfScale * 100)}%`;
        }
        
        async function navigateToWordIfNeeded(wordIndex) {
            const word = wordMap.find(w => w.index === wordIndex);
            if (word && word.page !== pdfCurrentPageNum) {
                await renderPage(word.page);
            }
        }

        function scrollToWord(wordIndex) {
            const wordSpan = document.querySelector(`.text-span[data-word-index="${wordIndex}"]`);
            if (wordSpan) {
                wordSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // --- AUDIO PLAYBACK & CHUNKING --- //
        function getChunkStartingAt(startIndex) {
            const chunkSize = 100;
            if (startIndex >= wordMap.length) return null;

            let endWordIndex = Math.min(startIndex + chunkSize - 1, wordMap.length - 1);

            // Try to end chunk at a sentence break for more natural pauses
            const lastThirdStartIndex = Math.floor(startIndex + (endWordIndex - startIndex) * 0.6);
            for (let i = endWordIndex; i > lastThirdStartIndex; i--) {
                if (wordMap[i].text.endsWith('.')) {
                    endWordIndex = i;
                    break;
                }
            }

            const wordsInChunk = wordMap.slice(startIndex, endWordIndex + 1);
            const text = wordsInChunk.map(w => w.text).join(' ');
            
            return {
                startIndex: startIndex,
                endIndex: endWordIndex,
                text: text,
                id: `chunk-${startIndex}`
            };
        }

        async function playFromWord(wordIndex) {
            if (isPlaying) await stopPlayback();
            
            const chunk = getChunkStartingAt(wordIndex);
            if (!chunk) return showError('Audio chunk not found for this word.');
            
            currentChunk = chunk;
            updateHighlighting();
            
            await navigateToWordIfNeeded(wordIndex);
            scrollToWord(wordIndex);
            
            isPlaying = true;
            isPaused = false;
            
            $('sticky-audio-player').classList.add('active');
            setTimeout(() => {
                applyPreferencesToUI();
            }, 100);
            updatePlayPauseButtons('pause');
            showLoading(`Generating audio...`);

            try {
                const audioUrl = await loadChunk(chunk);
                if (!gaplessPlayer) initializeWebAudioPlayer();
                await gaplessPlayer.play(audioUrl, chunk.id);
                
                const nextChunkStartIndex = chunk.endIndex + 1;
                if (nextChunkStartIndex < wordMap.length) {
                    preloadNextChunk(nextChunkStartIndex);
                }
            } catch (error) { 
                showError('Playback failed: ' + error.message); 
                stopPlayback(); 
            } finally { 
                hideLoading(); 
            }
        }

        async function playNextChunk() {
            const nextChunkStartIndex = currentChunk.endIndex + 1;
            if (nextChunkStartIndex >= wordMap.length) {
                stopPlayback();
                return;
            }

            const nextChunk = getChunkStartingAt(nextChunkStartIndex);
            if (!nextChunk) {
                stopPlayback();
                return;
            }
            
            currentChunk = nextChunk;
            updateHighlighting();
            await navigateToWordIfNeeded(currentChunk.startIndex);
            scrollToWord(currentChunk.startIndex);

            try {
                const audioUrl = await loadChunk(nextChunk);
                await gaplessPlayer.play(audioUrl, nextChunk.id);

                const subsequentChunkIndex = nextChunk.endIndex + 1;
                if (subsequentChunkIndex < wordMap.length) {
                    preloadNextChunk(subsequentChunkIndex);
                }
            } catch (error) {
                showError('Playback failed: ' + error.message);
                stopPlayback();
            }
        }

        function togglePlayPause() {
            if (!currentChunk) return;
            if (isPlaying && !isPaused) { 
                if (gaplessPlayer) { isPaused = true; isPlaying = false; gaplessPlayer.pause(); updatePlayPauseButtons('play'); }
            } else if (isPaused) { 
                if (gaplessPlayer) { isPaused = false; isPlaying = true; gaplessPlayer.resume(); updatePlayPauseButtons('pause'); }
            }
        }

        async function stopPlayback() {
            isPlaying = false; isPaused = false; currentChunk = null;
            if (gaplessPlayer) gaplessPlayer.stop();
            $('sticky-audio-player').classList.remove('active');
            updatePlayPauseButtons('play');
            updateHighlighting();
        }

        async function loadChunk(chunk) {
            if (audioCache.has(chunk.id)) return audioCache.get(chunk.id);
            
            const response = await fetch('/api/generate-audio', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: chunk.text, model: selectedModel })
            });
            if (!response.ok) throw new Error((await response.json()).error || 'API Error');
            
            const data = await response.json();
            const blob = new Blob([Uint8Array.from(atob(data.audio_data), c => c.charCodeAt(0))], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            audioCache.set(chunk.id, url);
            return url;
        }

        async function preloadNextChunk(wordIndex) {
            const chunk = getChunkStartingAt(wordIndex);
            if (chunk && !audioCache.has(chunk.id)) {
                await loadChunk(chunk);
            }
        }

        // --- UI & STATE MANAGEMENT --- //
        function updateHighlighting() {
            document.querySelectorAll('.text-span').forEach(s => s.classList.remove('word-playing-chunk'));
            
            if (!currentChunk || (!isPlaying && !isPaused)) return;

            for (let i = currentChunk.startIndex; i <= currentChunk.endIndex; i++) {
                const span = document.querySelector(`.text-span[data-word-index="${i}"]`);
                if (span) span.classList.add('word-playing-chunk');
            }
        }

        async function handleVoiceChange(newVoice) {
            selectedModel = newVoice;
            saveUserPreferences();
            applyPreferencesToUI();
            audioCache.clear();
            if (isPlaying || isPaused) {
                const savedIndex = currentChunk.startIndex;
                const wasPlaying = isPlaying;
                await stopPlayback();
                if(wasPlaying) await playFromWord(savedIndex);
            }
        }

        function changePlaybackRate(newRate) {
            currentPlaybackRate = String(newRate);
            saveUserPreferences();
            if (gaplessPlayer) {
                gaplessPlayer.changeSpeed(parseFloat(currentPlaybackRate));
            }
        }
        
        function resetToUpload() {
            stopPlayback();
            $('pdf-display').classList.add('hidden');
            $('upload-container').classList.remove('hidden');
            resetPdfState();
            $('pdf-input').value = '';
        }
        
        function resetPdfState() {
            pdfDoc = null; wordMap = []; audioCache.clear(); currentChunk = null;
            if ($('pdf-viewer')) $('pdf-viewer').innerHTML = '';
        }

        function loadUserPreferences() {
            try {
                const prefs = JSON.parse(localStorage.getItem('pdf-reader-prefs'));
                if (prefs) { 
                    selectedModel = prefs.voice || 'edge-tts-andrew'; 
                    currentPlaybackRate = prefs.speed || "1.0"; 
                }
            } catch (e) { console.error("Could not load user preferences", e); }
        }

        function saveUserPreferences() { 
            localStorage.setItem('pdf-reader-prefs', JSON.stringify({ voice: selectedModel, speed: currentPlaybackRate })); 
        }

        function applyPreferencesToUI() {
            $('sticky-voice-select').value = selectedModel;
            $('sticky-speed-select').value = currentPlaybackRate;
        }

        function updateFileInfo(name, wordCount) {
            $('file-name').textContent = name;
            $('word-count').textContent = `${wordCount}`;
            $('chunk-count').textContent = `${Math.ceil(wordCount / 100)}`;
            $('file-info').classList.remove('hidden');
        }

        function showUploadLoading(show, text = '') {
            $('upload-loading').classList.toggle('hidden', !show);
            if (show) $('upload-loading-text').textContent = text;
            $('upload-area').style.pointerEvents = show ? 'none' : 'auto';
        }

        function showLoading(text) { 
            $('loading-indicator').classList.remove('hidden'); 
            $('loading-text').textContent = text; 
        }
        function hideLoading() { 
            $('loading-indicator').classList.add('hidden'); 
        }
        function showError(msg) { 
            const errorSection = $('error-section');
            errorSection.classList.remove('hidden'); 
            $('error-message').textContent = msg; 
            setTimeout(() => {
                errorSection.classList.add('hidden');
            }, 5000);
        }
        
        function updatePlayPauseButtons(state) {
            const icon = $('sticky-play-pause-btn').querySelector('i');
            if (icon) { 
                icon.setAttribute('data-lucide', state); 
                lucide.createIcons(); 
            }
        }

        // --- WEB AUDIO PLAYER (HTML5 Audio Element based) --- //
        function initializeWebAudioPlayer() {
            const audioEl = $('audio-player-element');
            
            gaplessPlayer = {
                play: (url, chunkId) => {
                    audioEl.src = url;
                    audioEl.playbackRate = parseFloat(currentPlaybackRate);
                    audioEl.play();
                    
                    audioEl.onplaying = () => {
                        updateHighlighting();
                    };
                },
                pause: () => { 
                    audioEl.pause();
                },
                resume: () => { 
                    audioEl.play();
                },
                stop: () => { 
                    if (!audioEl.paused) {
                        audioEl.pause();
                    }
                    audioEl.removeAttribute('src');
                    audioEl.load();
                },
                changeSpeed: (newRate) => {
                    currentPlaybackRate = String(newRate);
                    audioEl.playbackRate = newRate;
                    saveUserPreferences();
                },
                getSource: () => null // Not applicable for HTML5 audio
            };

            audioEl.onended = () => {
                if (isPlaying && !isPaused) {
                    playNextChunk();
                }
            };
        }
    </script>
</body>
</html> 