<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicRead - Listen to your PDFs</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 75 33.51'%3e%3cg data-name='Layer 2'%3e%3cpath fill='%236D28D9' d='M75 23.6a10.5 10.5 0 0 1-10.63 9.91H38.82a2.14 2.14 0 0 1-2.12-2.13V3.87a2.34 2.34 0 0 1 1.41-2.24S40.46 0 45.41 0A16.74 16.74 0 0 1 54 2.36a17 17 0 0 1 8 11.08 9.8 9.8 0 0 1 2.71-.37A10.23 10.23 0 0 1 75 23.6ZM33.51 5.61a.83.83 0 1 0-1.65 0c-.7 9.25-1.24 17.92 0 27.14a.83.83 0 0 0 1.65 0c1.33-9.3.77-17.81 0-27.14ZM28.35 8.81a.87.87 0 0 0-1.73 0 103.7 103.7 0 0 0 0 23.95.87.87 0 0 0 1.72 0 93.2 93.2 0 0 0 .01-23.95ZM23.16 8a.84.84 0 0 0-1.67 0c-.79 8.44-1.19 16.32 0 24.74a.83.83 0 0 0 1.66 0c1.23-8.53.85-16.19.01-24.74ZM18 10.41a.86.86 0 0 0-1.72 0 87.61 87.61 0 0 0 0 22.36.85.85 0 0 0 1.69 0A81.68 81.68 0 0 0 18 10.41ZM12.79 16a.85.85 0 0 0-1.7 0c-1.23 5.76-.65 11 .05 16.83a.81.81 0 0 0 1.6 0c.77-5.91 1.36-11.03.05-16.83ZM7.62 15.12a.88.88 0 0 0-1.75 0C4.78 21 5.14 26.18 5.9 32.05c.08.89 1.59.88 1.69 0 .84-5.96 1.23-10.99.03-16.93ZM2.4 18a.88.88 0 0 0-1.75 0c-1 3.95-.69 7.22.07 11.18a.82.82 0 0 0 1.63 0c.88-4.04 1.31-7.24.05-11.18Z'/%3e%3c/g%3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #pdf-viewer { position: relative; overflow-y: auto; overflow-x: hidden; height: calc(100vh - 80px); /* Full height minus player */ }
        .pdf-page { position: relative; margin: 20px auto; background: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .pdf-page canvas { display: block; width: 100%; height: auto; }
        .text-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2; }
        .text-span {
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
        }
        .text-span:hover { background-color: hsla(var(--primary), 0.3) !important; }
        .text-span.word-playing-chunk { background-color: hsla(142, 71%, 41%, 0.2) !important; }
        .text-span.word-next-chunk { background-color: hsla(var(--primary), 0.15) !important; }
        .text-span.word-current {
            background-color: hsla(142, 71%, 41%, 0.6) !important;
            animation: pulse-word 1.5s infinite;
            z-index: 10 !important;
        }
        @keyframes pulse-word { 0%, 100% { transform: scale(1.0); } 50% { transform: scale(1.05); } }

        .upload-area.dragover {
            border-color: hsl(var(--primary));
            transform: scale(1.02);
            background-color: hsl(var(--secondary));
        }
    </style>
</head>
<body class="overscroll-none">
    <main id="app-container" class="transition-all duration-300">
        <div id="upload-container">
            <header class="absolute top-0 left-0 right-0 p-4">
                <div class="flex items-center justify-center max-w-5xl mx-auto">
                     <div class="flex items-center space-x-3">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-blue-500">
                            <path d="M2.75 12C2.75 11.5858 3.08579 11.25 3.5 11.25H4.25C4.66421 11.25 5 11.5858 5 12V16C5 16.4142 4.66421 16.75 4.25 16.75H3.5C3.08579 16.75 2.75 16.4142 2.75 16V12Z" fill="currentColor" />
                            <path d="M6.75 8C6.75 7.58579 7.08579 7.25 7.5 7.25H8.25C8.66421 7.25 9 7.58579 9 8V16C9 16.4142 8.66421 16.75 8.25 16.75H7.5C7.08579 16.75 6.75 16.4142 6.75 16V8Z" fill="currentColor" />
                            <path d="M10.75 10C10.75 9.58579 11.0858 9.25 11.5 9.25H12.25C12.6642 9.25 13 9.58579 13 10V16C13 16.4142 12.6642 16.75 12.25 16.75H11.5C11.0858 16.75 10.75 16.4142 10.75 16V10Z" fill="currentColor" />
                            <path d="M14.75 6C14.75 5.58579 15.0858 5.25 15.5 5.25H16.25C16.6642 5.25 17 5.58579 17 6V16C17 16.4142 16.6642 16.75 16.25 16.75H15.5C15.0858 16.75 14.75 16.4142 14.75 16V6Z" fill="currentColor" />
                            <path d="M18.75 9C18.75 8.58579 19.0858 8.25 19.5 8.25H20.25C20.6642 8.25 21 8.58579 21 9V16C21 16.4142 20.6642 16.75 20.25 16.75H19.5C19.0858 16.75 18.75 16.4142 18.75 16V9Z" fill="currentColor" />
                        </svg>
                        <h1 class="text-xl font-bold">SonicRead</h1>
                    </div>
                </div>
            </header>
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="text-center w-full max-w-2xl">
                    <h2 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-4">Listen to your PDFs, hands-free.</h2>
                    <p class="text-lg md:text-xl text-slate-400 mb-8 max-w-xl mx-auto">Upload any PDF and have it read out to you with perfectly synced text highlighting.</p>

                    <div id="upload-area" class="upload-area bg-slate-900/50 border-2 border-dashed border-slate-700 rounded-2xl p-8 md:p-12 text-center cursor-pointer group transition-all duration-300 hover:border-blue-500 hover:bg-slate-800/60">
                        <div class="flex flex-col items-center space-y-4">
                            <i data-lucide="upload-cloud" class="h-16 w-16 text-slate-500 group-hover:text-blue-500 transition-colors"></i>
                            <h4 class="text-2xl font-semibold text-slate-200">Drop your PDF here</h4>
                            <p class="text-lg text-slate-400">or <span class="text-blue-400 font-medium">click to browse</span></p>
                        </div>
                        <input type="file" id="pdf-input" accept=".pdf" class="hidden">
                    </div>
                    
                    <div id="upload-loading" class="hidden mt-8">
                        <div class="w-8 h-8 mx-auto spinner border-4 border-blue-400 border-t-transparent rounded-full"></div>
                        <p class="text-lg font-medium text-blue-300 mt-4" id="upload-loading-text">Processing PDF...</p>
                    </div>

                    <div id="file-info" class="hidden mt-6 p-4 bg-green-500/10 rounded-xl border border-green-500/30 text-left w-full max-w-md mx-auto">
                        <div class="font-semibold text-green-300" id="file-name"></div>
                        <div class="text-sm text-green-200"><span id="word-count"></span> words â€¢ <span id="chunk-count"></span> audio segments</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="pdf-display" class="hidden">
            <div id="pdf-top-bar" class="fixed top-0 left-0 right-0 z-40 bg-slate-900/80 backdrop-blur-xl border-b border-slate-700 shadow-md">
                <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center space-x-1 sm:space-x-2">
                             <button id="pdf-start-reading" class="flex items-center gap-2 px-2 md:px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-all"><i data-lucide="play-circle" class="h-5 w-5"></i><span class="hidden md:inline">Start Reading</span></button>
                             <button id="top-go-to-current" class="hidden items-center gap-2 px-2 md:px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-sm rounded-lg transition-all"><i data-lucide="crosshair" class="h-5 w-5"></i><span class="hidden md:inline">Go to Current</span></button>
                        </div>
                        <div class="flex items-center space-x-1 text-slate-300">
                             <button id="pdf-zoom-out" class="p-2 rounded-md hover:bg-slate-700 transition-colors"><i data-lucide="zoom-out" class="h-5 w-5"></i></button>
                             <span id="pdf-zoom-level" class="text-sm font-medium w-14 sm:w-16 text-center">100%</span>
                             <button id="pdf-zoom-in" class="p-2 rounded-md hover:bg-slate-700 transition-colors"><i data-lucide="zoom-in" class="h-5 w-5"></i></button>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-2">
                             <span id="pdf-page-indicator" class="text-sm font-medium text-slate-400 w-20 sm:w-24 text-center">Page 1 / 1</span>
                             <button id="pdf-fit-width" class="p-2 rounded-md hover:bg-slate-700 transition-colors hidden sm:block"><i data-lucide="move-horizontal" class="h-5 w-5"></i></button>
                             <button id="top-read-another-pdf-btn" class="flex items-center gap-2 px-2 md:px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-all"><i data-lucide="file-plus-2" class="h-5 w-5"></i><span class="hidden md:inline">New PDF</span></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pdf-container" class="bg-slate-800 pt-16">
                <div id="pdf-viewer"></div>
            </div>
            <div id="loading-indicator" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-4 bg-slate-900/80 backdrop-blur-sm rounded-lg border border-slate-700 shadow-lg z-50">
                <div class="flex items-center text-slate-300">
                    <div class="spinner h-5 w-5 border-2 border-slate-300 border-t-transparent rounded-full mr-3"></div>
                    <span id="loading-text"></span>
                </div>
            </div>
        </div>

        <div id="error-section" class="hidden fixed bottom-24 sm:bottom-4 left-1/2 -translate-x-1/2 w-auto bg-red-600/90 text-white p-4 rounded-lg shadow-lg z-[10000]">
            <p id="error-message"></p>
        </div>
    </main>

    <div id="sticky-audio-player" class="fixed bottom-0 left-0 right-0 z-[9999] bg-slate-900/80 backdrop-blur-xl border-t border-slate-700 transform translate-y-full transition-transform duration-300 ease-in-out">
        <!-- This is the player for larger screens -->
        <div class="hidden sm:flex items-center justify-between p-4 max-w-5xl mx-auto">
             <div class="flex items-center gap-4">
                <button id="sticky-play-pause-btn" class="p-2.5 rounded-full bg-blue-600 hover:bg-blue-700 text-white transition-all"><i data-lucide="pause" class="h-6 w-6"></i></button>
                <div class="flex items-center gap-3">
                    <div class="text-sm text-slate-400">Voice:</div>
                    <select id="sticky-voice-select" class="bg-slate-800 text-white text-sm rounded-md px-3 py-1.5 border border-slate-700 focus:border-blue-500 focus:ring-0 outline-none appearance-none">
                        {% for key, model in models.items() %}<option value="{{ key }}" {% if key == 'edge-tts-andrew' %}selected{% endif %}>{{ model.name }}</option>{% endfor %}
                    </select>
                </div>
                <div class="flex items-center gap-3">
                     <div class="text-sm text-slate-400">Speed:</div>
                     <select id="sticky-speed-select" class="bg-slate-800 text-white text-sm rounded-md px-3 py-1.5 border border-slate-700 focus:border-blue-500 focus:ring-0 outline-none appearance-none">
                        <option value="0.75">0.75x</option><option value="1.0" selected>1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2.0">2.0x</option>
                     </select>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="sticky-stop-btn" class="p-2.5 rounded-full bg-red-500/20 hover:bg-red-500/40 text-red-300 transition-all"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
        </div>

        <!-- This is the player for mobile screens -->
        <div class="sm:hidden flex flex-col p-4 gap-4">
            <div class="flex items-center justify-between">
                 <div class="flex items-center gap-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-blue-500">
                        <path d="M2.75 12C2.75 11.5858 3.08579 11.25 3.5 11.25H4.25C4.66421 11.25 5 11.5858 5 12V16C5 16.4142 4.66421 16.75 4.25 16.75H3.5C3.08579 16.75 2.75 16.4142 2.75 16V12Z" fill="currentColor" />
                        <path d="M6.75 8C6.75 7.58579 7.08579 7.25 7.5 7.25H8.25C8.66421 7.25 9 7.58579 9 8V16C9 16.4142 8.66421 16.75 8.25 16.75H7.5C7.08579 16.75 6.75 16.4142 6.75 16V8Z" fill="currentColor" />
                        <path d="M10.75 10C10.75 9.58579 11.0858 9.25 11.5 9.25H12.25C12.6642 9.25 13 9.58579 13 10V16C13 16.4142 12.6642 16.75 12.25 16.75H11.5C11.0858 16.75 10.75 16.4142 10.75 16V10Z" fill="currentColor" />
                        <path d="M14.75 6C14.75 5.58579 15.0858 5.25 15.5 5.25H16.25C16.6642 5.25 17 5.58579 17 6V16C17 16.4142 16.6642 16.75 16.25 16.75H15.5C15.0858 16.75 14.75 16.4142 14.75 16V6Z" fill="currentColor" />
                        <path d="M18.75 9C18.75 8.58579 19.0858 8.25 19.5 8.25H20.25C20.6642 8.25 21 8.58579 21 9V16C21 16.4142 20.6642 16.75 20.25 16.75H19.5C19.0858 16.75 18.75 16.4142 18.75 16V9Z" fill="currentColor" />
                    </svg>
                    <div class="text-sm font-medium">Now Playing</div>
                </div>
                 <button id="mobile-sticky-stop-btn" class="p-1.5 rounded-full text-slate-400 hover:bg-slate-700"><i data-lucide="x" class="h-5 w-5"></i></button>
            </div>
            <div class="flex items-center justify-between">
                <button id="mobile-speed-btn" class="w-12 h-12 flex items-center justify-center rounded-full bg-slate-800 text-sm font-bold">1.0x</button>
                <div class="flex items-center gap-4">
                     <button id="mobile-rewind-btn" class="p-3 text-slate-300"><i data-lucide="rewind" class="h-6 w-6"></i></button>
                     <button id="mobile-play-pause-btn" class="w-16 h-16 flex items-center justify-center rounded-full bg-blue-600 text-white shadow-lg shadow-blue-500/30"><i data-lucide="pause" class="h-8 w-8"></i></button>
                     <button id="mobile-forward-btn" class="p-3 text-slate-300"><i data-lucide="fast-forward" class="h-6 w-6"></i></button>
                </div>
                <button id="mobile-options-btn" class="w-12 h-12 flex items-center justify-center rounded-full bg-slate-800"><i data-lucide="more-horizontal" class="h-6 w-6"></i></button>
            </div>
             <!-- Mobile options panel -->
            <div id="mobile-options-panel" class="hidden bg-slate-800 rounded-lg p-4">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <label for="mobile-voice-select" class="text-sm text-slate-400">Voice</label>
                        <select id="mobile-voice-select" class="bg-slate-700 text-white text-sm rounded-md px-3 py-1.5 border border-slate-600 focus:border-blue-500 focus:ring-0 outline-none appearance-none">
                             {% for key, model in models.items() %}<option value="{{ key }}" {% if key == 'edge-tts-andrew' %}selected{% endif %}>{{ model.name }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="audio-player-element" style="display:none;"></audio>

    <script>
        lucide.createIcons();
        
        // --- GLOBAL STATE --- //
        let wordMap = [];
        let pdfDoc = null, pdfTotalPages = 0, pdfScale = 1.0;
        let audioCache = new Map(), gaplessPlayer = null, isPlaying = false, isPaused = false, currentChunk = null;
        let currentPlaybackRate = 1.0, selectedModel = 'edge-tts-andrew';
        let currentViewingPage = 1;
        let isViewChanging = false;

        const $ = (id) => document.getElementById(id);
        
        // --- INITIALIZATION --- //
        document.addEventListener('DOMContentLoaded', () => {
            loadUserPreferences();
            applyPreferencesToUI();
            setupEventListeners();
        });

        function setupEventListeners() {
            const uploadArea = $('upload-area');
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', (e) => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
            uploadArea.addEventListener('click', () => $('pdf-input').click());
            $('pdf-input').addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
            
            // Desktop player controls
            $('sticky-play-pause-btn').addEventListener('click', togglePlayPause);
            $('sticky-stop-btn').addEventListener('click', closePlayer);
            $('sticky-speed-select').addEventListener('change', (e) => changePlaybackRate(e.target.value));
            $('sticky-voice-select').addEventListener('change', (e) => handleVoiceChange(e.target.value));

            // Top bar controls
            $('pdf-start-reading').addEventListener('click', () => playFromWord(0));
            $('top-go-to-current').addEventListener('click', goToCurrentHighlight);
            $('pdf-zoom-in').addEventListener('click', () => { changeZoom(0.25); });
            $('pdf-zoom-out').addEventListener('click', () => { changeZoom(-0.25); });
            $('pdf-fit-width').addEventListener('click', async () => { await fitToWidth(); await rerenderVisiblePages(); });
            $('top-read-another-pdf-btn').addEventListener('click', resetToUpload);

            // Mobile player controls
            $('mobile-play-pause-btn').addEventListener('click', togglePlayPause);
            $('mobile-sticky-stop-btn').addEventListener('click', closePlayer);
            $('mobile-speed-btn').addEventListener('click', cyclePlaybackSpeed);
            $('mobile-voice-select').addEventListener('change', (e) => handleVoiceChange(e.target.value));
            $('mobile-options-btn').addEventListener('click', () => $('mobile-options-panel').classList.toggle('hidden'));
            $('mobile-rewind-btn').addEventListener('click', () => seek(-10));
            $('mobile-forward-btn').addEventListener('click', () => seek(10));

            document.addEventListener('keydown', (e) => { 
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                if (e.key === ' ') { 
                    e.preventDefault();
                    togglePlayPause(); 
                }
            });
        }

        // --- PDF PROCESSING & RENDERING --- //
        async function handleFile(file) {
            if (!file.type.includes('pdf')) return showError('Please select a PDF file.');
            showUploadLoading(true, 'Uploading and processing PDF...');
            await stopPlayback();
            resetPdfState();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Server error during PDF processing');
                }

                const data = await response.json();
                wordMap = data.words;

                const arrayBuffer = await file.arrayBuffer();
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                pdfDoc = await loadingTask.promise;
                pdfTotalPages = pdfDoc.numPages;

                updateFileInfo(data.filename, data.word_count);
                $('upload-container').classList.add('hidden');
                $('pdf-display').classList.remove('hidden');
                
                await fitToWidth();
                await renderInitialView();
                setupScrollListener();
                updatePageIndicator();

            } catch (error) {
                showError('Failed to process PDF: ' + error.message);
                console.error(error);
                resetToUpload();
            } finally {
                showUploadLoading(false);
            }
        }
        
        async function renderInitialView() {
            showLoading(`Rendering initial pages...`);
            const viewer = $('pdf-viewer');
            viewer.innerHTML = '';
            
            const numPagesToRender = Math.min(5, pdfTotalPages);

            for (let pageNum = 1; pageNum <= numPagesToRender; pageNum++) {
                await renderSinglePage(pageNum, viewer);
            }

            hideLoading();
            if (isPlaying || isPaused) updateHighlighting();
        }

        async function renderAllPages() {
            showLoading(`Rendering ${pdfTotalPages} pages...`);
            const viewer = $('pdf-viewer');
            viewer.innerHTML = '';

            for (let pageNum = 1; pageNum <= pdfTotalPages; pageNum++) {
                await renderSinglePage(pageNum, viewer);
            }

            hideLoading();
            if (isPlaying || isPaused) updateHighlighting();
        }

        async function renderSinglePage(pageNum, viewer) {
             try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: pdfScale });

                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page';
                pageDiv.dataset.pageNum = pageNum;
                pageDiv.style.width = `${viewport.width}px`;
                pageDiv.style.height = `${viewport.height}px`;

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                pageDiv.appendChild(canvas);

                const textLayer = document.createElement('div');
                textLayer.className = 'text-layer';
                pageDiv.appendChild(textLayer);
                
                viewer.appendChild(pageDiv);

                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                const wordsOnPage = wordMap.filter(w => w.page === pageNum);
                if (wordsOnPage.length > 0) {
                    const originalPage = {width: wordsOnPage[0].page_width, height: wordsOnPage[0].page_height};
                    const scaleX = viewport.width / originalPage.width;
                    const scaleY = viewport.height / originalPage.height;

                    for (const word of wordsOnPage) {
                        const span = document.createElement('span');
                        span.className = 'text-span';
                        span.dataset.wordIndex = word.index;
                        
                        const style = span.style;
                        style.left = `${word.x * scaleX}px`;
                        style.top = `${word.y * scaleY}px`;
                        style.width = `${word.width * scaleX}px`;
                        style.height = `${word.height * scaleY}px`;

                        span.addEventListener('click', () => playFromWord(word.index));
                        textLayer.appendChild(span);
                    }
                }
            } catch(e) {
                console.error(`Failed to render page ${pageNum}`, e);
                showError(`Error rendering page ${pageNum}.`);
            }
        }

        async function fitToWidth() {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(1);
            const containerWidth = $('pdf-container').clientWidth;
            pdfScale = containerWidth / page.getViewport({ scale: 1 }).width;
            updateZoomLevel();
        }

        function setupScrollListener() {
            const viewer = $('pdf-viewer');
            let scrollTimeout;
            
            viewer.addEventListener('scroll', async () => {
                if (isViewChanging) return;

                const { scrollTop, scrollHeight, clientHeight } = viewer;
                if (scrollHeight - scrollTop - clientHeight < clientHeight * 1.5) { // Load when 1.5 screens away from bottom
                    isViewChanging = true;
                    await maintainSlidingWindow();
                    isViewChanging = false;
                }
                 updateCurrentViewingPage();
            }, { passive: true });
        }

        function updateCurrentViewingPage() {
            const viewer = $('pdf-viewer');
            const viewerRect = viewer.getBoundingClientRect();
            const viewerMiddle = viewerRect.top + (viewerRect.height / 3);

            const pageElements = document.querySelectorAll('[data-page-num]');
            for (const pageEl of pageElements) {
                const pageRect = pageEl.getBoundingClientRect();
                if (pageRect.top <= viewerMiddle && pageRect.bottom >= viewerMiddle) {
                    currentViewingPage = parseInt(pageEl.dataset.pageNum);
                    updatePageIndicator();
                    break;
                }
            }
        }

        function updatePageIndicator() {
            if (pdfDoc) {
                $('pdf-page-indicator').textContent = `Page ${currentViewingPage} / ${pdfTotalPages}`;
            }
        }

        async function maintainSlidingWindow() {
            try {
                const pageElements = document.querySelectorAll('.pdf-page');
                const lastRenderedPage = pageElements.length > 0
                    ? Array.from(pageElements).reduce((max, p) => Math.max(max, parseInt(p.dataset.pageNum)), 0)
                    : 0;

                if (lastRenderedPage >= pdfTotalPages) return;

                const nextPatoLoad = lastRenderedPage + 1;
                const endPageToLoad = Math.min(lastRenderedPage + 3, pdfTotalPages); // Load 3 more pages

                if (nextPatoLoad > endPageToLoad) return;

                showLoading(`Loading pages ${nextPatoLoad}-${endPageToLoad}...`);
                const viewer = $('pdf-viewer');
                for (let pageNum = nextPatoLoad; pageNum <= endPageToLoad; pageNum++) {
                    if (!document.querySelector(`[data-page-num="${pageNum}"]`)) {
                        await renderSinglePage(pageNum, viewer);
                    }
                }
                hideLoading();
            } catch(e) {
                console.error("Error in maintainSlidingWindow: ", e);
            }
        }

        async function scrollToWord(wordIndex) {
            if (isViewChanging) return;

            const wordInfo = wordMap[wordIndex];
            if (!wordInfo) return;

            const targetPageNum = wordInfo.page;
            const viewer = $('pdf-viewer');
            let pageElement = viewer.querySelector(`[data-page-num="${targetPageNum}"]`);

            if (!pageElement) {
                isViewChanging = true;
                try {
                    showLoading(`Jumping to page ${targetPageNum}...`);
                    
                    viewer.innerHTML = '';
                    
                    const startPage = Math.max(1, targetPageNum - 2);
                    const endPage = Math.min(pdfTotalPages, targetPageNum + 2);

                    const fragment = document.createDocumentFragment();
                    for (let i = startPage; i <= endPage; i++) {
                        await renderSinglePage(i, fragment);
                    }
                    viewer.appendChild(fragment);

                    if (isPlaying || isPaused) updateHighlighting();
                    
                    hideLoading();
                } finally {
                    isViewChanging = false;
                }
            }
            
            const wordSpan = document.querySelector(`.text-span[data-word-index="${wordIndex}"]`);
            if (wordSpan) {
                wordSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentViewingPage = targetPageNum;
                updatePageIndicator();
            }
        }

        async function goToCurrentHighlight() {
            if (!currentChunk) return showError('Nothing is playing.');
            const firstWordIndex = currentChunk.startIndex;
            await scrollToWord(firstWordIndex);
        }

        // --- AUDIO PLAYBACK & CHUNKING --- //
        function getChunkForWord(wordIndex) {
            if (wordIndex >= wordMap.length) return null;

            let startIndex = wordIndex;
            let endIndex = startIndex;
            let sentenceCount = 0;
            const targetSentenceCount = 3;

            for (let i = startIndex; i < wordMap.length; i++) {
                endIndex = i;
                const wordText = wordMap[i].text;
                if (wordText.match(/[.?!]\s*$/)) {
                    sentenceCount++;
                    if (sentenceCount >= targetSentenceCount) {
                        break;
                    }
                }
            }
            
            const wordsInChunk = wordMap.slice(startIndex, endIndex + 1);
            const text = wordsInChunk.map(w => w.text).join(' ');
            
            return {
                startIndex: startIndex,
                endIndex: endIndex,
                text: text,
                id: `chunk-${startIndex}`
            };
        }

        async function playFromWord(wordIndex) {
            if (isPlaying) await stopPlayback();
            
            const chunk = getChunkForWord(wordIndex);
            if (!chunk) return showError('Audio chunk not found for this word.');
            
            currentChunk = chunk;
            
            showPlayer();
            await scrollToWord(wordIndex);
            
            isPlaying = true;
            isPaused = false;
            
            updatePlayPauseButtons('pause');
            updateHighlighting();
            
            try {
                const audioUrl = await loadChunk(chunk);
                if (!gaplessPlayer) initializeWebAudioPlayer();
                await gaplessPlayer.play(audioUrl, chunk.id);
                
                const nextChunkStartIndex = chunk.endIndex + 1;
                if (nextChunkStartIndex < wordMap.length) {
                    preloadNextChunk(nextChunkStartIndex);
                }
            } catch (error) { 
                showError('Playback failed: ' + error.message); 
                stopPlayback(); 
            }
        }

        async function playNextChunk() {
            if (!currentChunk) { stopPlayback(); return; }
            const nextChunkStartIndex = currentChunk.endIndex + 1;
            if (nextChunkStartIndex >= wordMap.length) {
                stopPlayback();
                return;
            }
            
            const nextChunk = getChunkForWord(nextChunkStartIndex);
            if (!nextChunk) {
                stopPlayback();
                return;
            }
            
            currentChunk = nextChunk;
            updateHighlighting();
            await scrollToWord(currentChunk.startIndex);

            try {
                const audioUrl = await loadChunk(nextChunk);
                await gaplessPlayer.play(audioUrl, nextChunk.id);

                const subsequentChunkIndex = nextChunk.endIndex + 1;
                if (subsequentChunkIndex < wordMap.length) {
                    preloadNextChunk(subsequentChunkIndex);
                }
            } catch (error) {
                showError('Playback failed: ' + error.message);
                stopPlayback();
            }
        }

        function togglePlayPause() {
            if (!currentChunk) return;
            if (isPlaying && !isPaused) {
                if (gaplessPlayer) { isPaused = true; isPlaying = false; gaplessPlayer.pause(); updatePlayPauseButtons('play'); }
            } else if (isPaused) {
                if (gaplessPlayer) { isPaused = false; isPlaying = true; gaplessPlayer.resume(); updatePlayPauseButtons('pause'); }
            }
        }
        
        function closePlayer() {
            hidePlayer();
            stopPlayback();
        }

        async function stopPlayback() {
            isPlaying = false; isPaused = false; currentChunk = null;
            if (gaplessPlayer) gaplessPlayer.stop();
            updatePlayPauseButtons('play');
            updateHighlighting();
            $('top-go-to-current').classList.add('hidden');
            $('top-go-to-current').classList.remove('flex');
        }

        async function loadChunk(chunk) {
            const cacheKey = `${chunk.id}-${selectedModel}`;
            if (audioCache.has(cacheKey)) return audioCache.get(cacheKey);
            showLoading('Generating audio...');
            
            const response = await fetch('/api/generate-audio', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: chunk.text, model: selectedModel })
            });

            hideLoading();
            if (!response.ok) throw new Error((await response.json()).error || 'API Error');
            
            const data = await response.json();
            const blob = new Blob([Uint8Array.from(atob(data.audio_data), c => c.charCodeAt(0))], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            audioCache.set(cacheKey, url);
            return url;
        }

        async function preloadNextChunk(wordIndex) {
            const chunk = getChunkForWord(wordIndex);
            if (chunk && !audioCache.has(`${chunk.id}-${selectedModel}`)) {
                await loadChunk(chunk);
            }
        }
        
        function seek(seconds) {
            if (!gaplessPlayer) return;
            const audioEl = $('audio-player-element');
            const newTime = audioEl.currentTime + seconds;
            
            if (newTime < 0) {
                 // rewind to previous chunk
                 const prevChunkIndex = currentChunk.startIndex - 1;
                 if (prevChunkIndex >= 0) playFromWord(prevChunkIndex);
            } else if (newTime >= audioEl.duration) {
                playNextChunk();
            } else {
                audioEl.currentTime = newTime;
            }
        }

        // --- UI & STATE MANAGEMENT --- //
        function updateHighlighting() {
            document.querySelectorAll('.text-span.word-playing-chunk').forEach(s => s.classList.remove('word-playing-chunk'));
            
            if (!currentChunk || (!isPlaying && !isPaused)) return;

            for (let i = currentChunk.startIndex; i <= currentChunk.endIndex; i++) {
                const span = document.querySelector(`.text-span[data-word-index="${i}"]`);
                if (span) span.classList.add('word-playing-chunk');
            }
            $('top-go-to-current').classList.remove('hidden');
            $('top-go-to-current').classList.add('flex');
        }

        async function handleVoiceChange(newVoice) {
            selectedModel = newVoice;
            saveUserPreferences();
            applyPreferencesToUI();
            
            if (isPlaying || isPaused) {
                const savedIndex = currentChunk.startIndex;
                const wasPlaying = isPlaying;
                await stopPlayback();
                if(wasPlaying) {
                    await playFromWord(savedIndex);
                }
            }
        }

        function changePlaybackRate(newRate) {
            currentPlaybackRate = parseFloat(newRate);
            saveUserPreferences();
            applyPreferencesToUI();
            if (gaplessPlayer) {
                gaplessPlayer.changeSpeed(currentPlaybackRate);
            }
        }

        function cyclePlaybackSpeed() {
            const speeds = [0.75, 1.0, 1.25, 1.5, 2.0];
            const currentIndex = speeds.indexOf(currentPlaybackRate);
            const nextIndex = (currentIndex + 1) % speeds.length;
            changePlaybackRate(speeds[nextIndex]);
        }
        
        function resetToUpload() {
            closePlayer();
            $('pdf-display').classList.add('hidden');
            $('upload-container').classList.remove('hidden');
            document.body.classList.remove('reading');
            $('app-container').style.paddingBottom = '0px';
            resetPdfState();
            $('pdf-input').value = '';
        }
        
        function resetPdfState() {
            pdfDoc = null; wordMap = []; audioCache.clear(); currentChunk = null;
            if ($('pdf-viewer')) $('pdf-viewer').innerHTML = '';
        }

        function loadUserPreferences() {
            try {
                const prefs = JSON.parse(localStorage.getItem('sonic-reader-prefs'));
                if (prefs) { 
                    selectedModel = prefs.voice || 'edge-tts-andrew'; 
                    currentPlaybackRate = parseFloat(prefs.speed || 1.0); 
                } else {
                    currentPlaybackRate = 1.0;
                }
            } catch (e) { 
                console.error("Could not load user preferences", e); 
                currentPlaybackRate = 1.0;
            }
        }

        function saveUserPreferences() { 
            localStorage.setItem('sonic-reader-prefs', JSON.stringify({ voice: selectedModel, speed: currentPlaybackRate })); 
        }

        function applyPreferencesToUI() {
            $('sticky-voice-select').value = selectedModel;
            $('mobile-voice-select').value = selectedModel;
            
            let speedValue = String(currentPlaybackRate);
            // If the number is an integer (e.g., 1, 2), format it with one decimal place.
            if (currentPlaybackRate % 1 === 0) {
                speedValue = currentPlaybackRate.toFixed(1);
            }
            $('sticky-speed-select').value = speedValue;
            $('mobile-speed-btn').textContent = `${speedValue}x`;
        }

        function updateFileInfo(name, wordCount) {
            $('file-name').textContent = name;
            $('word-count').textContent = `${wordCount}`;
            $('chunk-count').textContent = `${Math.ceil(wordCount / 100)}`;
            $('file-info').classList.remove('hidden');
        }

        function showUploadLoading(show, text = '') {
            $('upload-loading').classList.toggle('hidden', !show);
            if (show) $('upload-loading-text').textContent = text;
            $('upload-area').style.pointerEvents = show ? 'none' : 'auto';
        }

        function showLoading(text) { 
            $('loading-indicator').classList.remove('hidden'); 
            $('loading-text').textContent = text; 
        }
        function hideLoading() { 
            $('loading-indicator').classList.add('hidden'); 
        }
        function showError(msg) { 
            const errorSection = $('error-section');
            errorSection.classList.remove('hidden'); 
            $('error-message').textContent = msg; 
            setTimeout(() => {
                errorSection.classList.add('hidden');
            }, 5000);
        }
        
        function updatePlayPauseButtons(state) { // state is 'play' or 'pause'
            const iconClass = state === 'pause' ? 'pause' : 'play';
            $('sticky-play-pause-btn').innerHTML = `<i data-lucide="${iconClass}" class="h-6 w-6"></i>`;
            $('mobile-play-pause-btn').innerHTML = `<i data-lucide="${iconClass}" class="h-8 w-8"></i>`;
            lucide.createIcons();
        }
        
        function showPlayer() {
            const player = $('sticky-audio-player');
            player.classList.remove('translate-y-full');
            document.body.classList.add('reading');
            const playerHeight = player.offsetHeight;
            $('app-container').style.paddingBottom = `${playerHeight}px`;
        }

        function hidePlayer() {
            const player = $('sticky-audio-player');
            player.classList.add('translate-y-full');
            document.body.classList.remove('reading');
            $('app-container').style.paddingBottom = '0px';
        }

        // --- WEB AUDIO PLAYER (HTML5 Audio Element based) --- //
        function initializeWebAudioPlayer() {
            const audioEl = $('audio-player-element');
            
            gaplessPlayer = {
                play: (url, chunkId) => {
                    return new Promise((resolve, reject) => {
                        audioEl.src = url;
                        audioEl.playbackRate = currentPlaybackRate;
                        audioEl.play().catch(e => {
                            showError("Playback was interrupted.");
                            reject(e);
                        });
                        
                        audioEl.onplaying = () => {
                            resolve();
                        };
                    });
                },
                pause: () => { 
                    audioEl.pause();
                },
                resume: () => { 
                    audioEl.play();
                },
                stop: () => { 
                    if (!audioEl.paused) {
                        audioEl.pause();
                    }
                    audioEl.removeAttribute('src');
                    audioEl.load();
                },
                changeSpeed: (newRate) => {
                    currentPlaybackRate = newRate;
                    audioEl.playbackRate = newRate;
                    saveUserPreferences();
                }
            };

            audioEl.onended = () => {
                if (isPlaying && !isPaused) {
                    playNextChunk();
                }
            };
        }

        async function changeZoom(amount) {
            if (!pdfDoc) return;
            pdfScale += amount;
            pdfScale = Math.max(0.5, Math.min(3, pdfScale)); // Clamp scale
            updateZoomLevel();
            await rerenderVisiblePages();
        }

        function updateZoomLevel() {
            $('pdf-zoom-level').textContent = `${Math.round(pdfScale * 100)}%`;
        }

        async function rerenderVisiblePages() {
            if (!pdfDoc || isViewChanging) return;
            isViewChanging = true;
            try {
                const viewer = $('pdf-viewer');
                const pageElements = Array.from(viewer.querySelectorAll('[data-page-num]'));
                const pagesToRender = pageElements.map(el => parseInt(el.dataset.pageNum));
                
                showLoading(`Applying zoom...`);
                
                viewer.innerHTML = '';
                
                const fragment = document.createDocumentFragment();
                for (const pageNum of pagesToRender) {
                    await renderSinglePage(pageNum, fragment);
                }
                
                viewer.appendChild(fragment);

                hideLoading();
                if (isPlaying || isPaused) updateHighlighting();
            } finally {
                isViewChanging = false;
            }
        }
    </script>
</body>
</html> 